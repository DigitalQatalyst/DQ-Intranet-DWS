pr: none
trigger: none

pool:
  vmImage: ubuntu-latest

variables:
- group: ovh-registry-secrets
- name: imageName
  value: frontend
- name: registry
  value: u4c2j2w9.c1.gra9.container-registry.ovh.net/dws
- name: imageTag
  value: release-$(Build.BuildId)
- name: namespace
  value: dws

stages:
- stage: Build
  displayName: Build and Push Image
  jobs:
  - job: Build
    displayName: Docker Build
    steps:
    - checkout: self

    - task: Docker@2
      displayName: Build & Push Frontend
      inputs:
        containerRegistry: OVH-Registry
        repository: dws/frontend
        command: buildAndPush
        Dockerfile: Dockerfile
        tags: |
          $(imageTag)

- stage: Deploy
  displayName: Deploy to OVH Kubernetes
  dependsOn: Build
  condition: succeeded()

  jobs:
  - job: Deploy
    displayName: Kubernetes Deploy
    steps:
  # 1️ Deploy new image
    - task: KubernetesManifest@1
      displayName: Deploy Frontend
      inputs:
        action: deploy
        kubernetesServiceConnection: OVH-Test-Kubeconfig
        namespace: $(namespace)
        manifests: |
          k8s/overlays/release/deployment.yaml
        containers: |
          $(registry)/$(imageName):$(imageTag)

  # 2️ Verify rollout (FAILS job if rollout fails)
    - task: Kubernetes@1
      displayName: Verify Rollout
      inputs:
        connectionType: Kubernetes service connection
        kubernetesServiceEndpoint: OVH-Test-Kubeconfig
        namespace: $(namespace)
        command: rollout
        arguments: status deployment/dws-frontend --timeout=120s

  # 3️ Rollback on failure
    - task: Kubernetes@1
      displayName: Rollback Deployment
      condition: failed()
      inputs:
        connectionType: Kubernetes service connection
        kubernetesServiceEndpoint: OVH-Test-Kubeconfig
        namespace: $(namespace)
        command: rollout
        arguments: undo deployment/dws-frontend

  # 4️ Explicit failure marker (optional but clear)
    - script: |
        echo "Deployment failed. Rollback was executed."
        exit 1
      condition: failed()
      displayName: Mark Deployment as Failed